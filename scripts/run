#!/usr/bin/env bash

source "$(dirname "${BASH_SOURCE[0]}")/common.sh"
cd "$WORKDIR"

# Atalhos: comando → comando completo no container
case "${1:-}" in
  setup)
    shift
    # Dev: bin/setup no container web; depois test: db:prepare no container test
    $DOCKER_COMPOSE run --rm web bin/setup "$@"
    echo ""
    echo "== Preparing test database (container test) =="
    exec $DOCKER_COMPOSE run --rm test bundle exec rails db:prepare
    ;;
  console)
    shift
    set -- bundle exec rails console "$@"
    ;;
  bash)
    shift
    set -- bash "$@"
    ;;
  rspec)
    shift
    set -- bundle exec rspec "$@"
    ;;
  rails)
    shift
    set -- bundle exec rails "$@"
    ;;
  rake)
    shift
    set -- bundle exec rake "$@"
    ;;
  bash|sh)
    shell="${1}"
    shift
    if [[ $# -eq 0 ]]; then
      exec $DOCKER_COMPOSE run --rm web "$shell"
    else
      exec $DOCKER_COMPOSE run --rm web "$shell" -c "$*"
    fi
    ;;
  install)
    shift
    set -- bundle install "$@"
    ;;
esac

# Sem argumentos → inicia a aplicação
if [[ $# -eq 0 ]]; then
  exec $DOCKER_COMPOSE up web
fi

# RSpec usa o serviço test (DATABASE_URL=myapp_test); demais comandos usam web
SERVICE=web
if [[ "${1:-}" == "bundle" && "${2:-}" == "exec" && "${3:-}" == "rspec" ]]; then
  SERVICE=test
fi

exec $DOCKER_COMPOSE run --rm $SERVICE "$@"
